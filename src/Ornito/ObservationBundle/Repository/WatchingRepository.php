<?php

namespace Ornito\ObservationBundle\Repository;

use Doctrine\ORM\Tools\Pagination\Paginator;
use Ornito\ObservationBundle\Entity\Watching;


/**
 * WatchingRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class WatchingRepository extends \Doctrine\ORM\EntityRepository
{


    /**
     * @param $page
     * @param $nbPerPage
     * @param $status
     * @param $order
     * @return Paginator
     */
    function getObs($page, $nbPerPage, $status, $order)
    {
        $qb = $this->createQueryBuilder('w')
            ->leftJoin('w.user', 'user')
            ->addSelect('user')
            ->leftJoin('w.image', 'img')
            ->addSelect('img')
            ->leftJoin('w.species', 'species')
            ->addSelect('species')
            ->where('w.validateStatus = :validateStatus')
            ->setParameter('validateStatus', $status)
            ->orderBy('w.date', $order)
            ->getQuery()
        ;

        $qb
            ->setFirstResult(($page-1) * $nbPerPage)
            ->setMaxResults($nbPerPage)
        ;

        return new Paginator($qb, true);

    }


    /**
     * @param $birdId
     * @param string $format
     * @return array|mixed
     */
    function findObsByBirdSelector($birdId, $format = 'html')
    {
        $qb = $this->createQueryBuilder('w')
            ->leftJoin('w.user', 'user')
            ->addSelect('user')
            ->leftJoin('w.image', 'img')
            ->addSelect('img')
            ->leftJoin('w.species', 'species')
            ->addSelect('species')
            ->where('species.id = :birdId')
            ->setParameter('birdId', $birdId)
            ->andWhere('w.validateStatus = :validateStatus')
            ->setParameter('validateStatus', Watching::ATTESTED)
            ->orderBy('w.date', 'DESC')
        ;
        if ($format == 'json') {
          $result = $qb
              ->getQuery()
              ->getArrayResult()
          ;
        } else {
          $result = $qb
              ->getQuery()
              ->getResult()
          ;
        }

        sort($result);

        return $result;
    }
}
